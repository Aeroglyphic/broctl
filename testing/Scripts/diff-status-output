#! /usr/bin/env bash
#
# Replace columns from "broctl status" output that are not predictable
# (such as PID) with Xs.
#
# If the "--peers" command-line option is given, then the "Peers" column
# is not replaced.  If the "--time" command-line option is given, then
# the "Started" date/time columns are not replaced.
# The "--quick" command-line option must be given when the quick status output
# (i.e., no peers column) is being used.

usepeers=0
if [ "$1" = "--peers" ]; then
    usepeers=1
fi
usetimefmt=0
if [ "$1" = "--time" ]; then
    usetimefmt=1
fi
tcol=7
if [ "$1" = "--quick" ]; then
    tcol=6
fi

awk -v tcol=${tcol} -v peers=${usepeers} -v usetimefmt=${usetimefmt} '{
    if ( NR > 1 )
    {
        # Check the format of each field, and replace with Xs only if the
        # format is expected (some fields have unpredictable length, but
        # we need a constant-width string of Xs).
        if ( $5 ~ /^[0-9]+$/ ) { $5 = "XXXXX" }   # Pid
        if ( peers == 0 ) {
            if ( $6 ~ /^([0-9]+|\?+)$/ ) { $6 = "X" }
        }

        if ( usetimefmt == 0) {
            # The "Started" column consists of three fields:
            tc=tcol;
            if ( $tc ~ /^[0-3][0-9]$/ ) { $tc = "XX" }
            tc++;
            if ( $tc ~ /^[A-Za-z]+$/ ) { $tc = "XXX" }
            tc++;
            if ( $tc ~ /^[0-2][0-9]:[0-5][0-9]:[0-5][0-9]$/ ) { $tc = "XX:XX:XX" }
        }
    }

    print
}'

